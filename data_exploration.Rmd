---
title: "Data Exploration"
author: "Elliott O'Brien"
date: "`r Sys.time()`"
output:
  html_document:
    df_print: paged
editor_options: 
  markdown: 
    wrap: 72
---

```{r data_prep_setup, include = FALSE}
library('knitr')
knitr::opts_chunk$set(echo = TRUE)
```

```{r data_prep_libraries, include = FALSE}
library('tidyverse')
theme_set(theme_bw())
library('rnaturalearth')
library('rnaturalearthdata')
library('broom')
library('caret')
```

```{r data_prep_load_data, include = FALSE}
datacamp_dataset_repo <- 'https://raw.githubusercontent.com/datacamp/careerhub-data/master'

# belgium_train <- read_delim(
#   str_c(datacamp_dataset_repo, '/Belgium%20Train%20Times/belgium-train-times.csv'),
#   delim = ';'
# )
# electricity <- read_csv(str_c(datacamp_dataset_repo, '/Electricity%20Prices/electricity_prices.csv'))
protest <- read_csv(str_c(datacamp_dataset_repo, '/Mass%20Protest%20Data/protest_data.csv'))
bike_crashes <- read_csv(str_c(datacamp_dataset_repo, '/Pedestrian%20and%20Bike%20Crashes/pedestrian_bike_crash.csv'))
```

# Dataset Choices

## Protest Data World-Wide

  *   The Protest dataset lends itself to many different types of classification
  and statistical models
  *   I'm interested to learn from this data, if we can predict if a protest 
  will become violent; to determine what features presented in the dataset are 
  good predictors of violence; comparing multiple models' predictive abilities
  *   The large number of features (31), would need to be reduced by PCA or a 
  regularization metric such as lasso or ridge for a linear model

```{r explore_protest, echo=TRUE, message=FALSE, warning=FALSE}
# glimpse(protest)

# protest %>%
#   group_by(country) %>%
#   summarize(
#     n_violent_protests = sum(protesterviolence, na.rm = T),
#     n_protests = n(),
#     percent_violent_country = round(n_violent_protests / n() * 100, 2)
#   ) %>%
#   mutate(
#     percent_violent_world = round(n_violent_protests / sum(n_violent_protests) * 100, 2)
#   ) %>%
#   arrange(
#     desc(percent_violent_world)
#   )
```

## Bicycle Crash Data in North Carolina

  *   The bike_crashes dataset has the most features of the other potential 
  datasets of interest
  *   some data/stats could be visualized on a geographical map
  *   Models could be developed to classify crash severity, intersection and 
  street with high risk/danger of bike crashes
  *   Subgroup analyses could be done on types of crashes, county, city, region, 
  etc.
  *   The large number of variables (61) with multiple levels for some 
  categorical variables.  Dataset would need to be reduced by PCA or a 
  regularization metric such as lasso or ridge for a linear model

```{r explore_bike_crashes, echo=TRUE, message=FALSE, warning=FALSE}
county_bike_crashes <- bike_crashes %>%
  group_by(County, CrashGrp) %>%
  summarize(
    crashes = n_distinct(CrashID)
  )

NC_map_coords <- map_data("county", "North Carolina") %>% 
  transmute(
    lon = long, 
    lat, 
    group, 
    county = str_to_title(subregion)
  )

NC_bike_crash_map_coords <- NC_map_coords %>%
  left_join(
    county_bike_crashes, 
    by = c('county' = 'County')
  ) %>% 
  group_by(county, ) %>%
  mutate(
    crashes = sum(crashes, na.rm=TRUE),
    log_crashes = log(crashes)
  )

NC_bike_crash_map_coords %>%
  ggplot(aes(lon, lat, group = county, fill = crashes)) +
  geom_polygon(col = 'grey') +
  scale_fill_continuous(type = "viridis") +
  coord_quickmap()

NC_bike_crash_map_coords %>%
  ggplot(aes(lon, lat, group = county, fill = log_crashes)) +
  geom_polygon(col = 'grey') +
  scale_fill_continuous(type = "viridis") +
  coord_quickmap()

########################################################
### Exploring usability of variables present in data ###
########################################################

## Variables to remove: ##
# * X and Y are longitude and latitude which are already present in the data
# * OBJECTID and OBJECTID_1 seem like a row number id which is not a very useful 
#   feature.  Also these are duplicated columns.
# * BikeInjury, DrvrInjury and CrashSevr use similar categories but different 
#   values in each record.  These columns will need to be observed closely.
#   since crash severity column has 7 observations where crash_sevr = 'Killed' 
#   but neither BikeInjury nor DrvrInjury were considered fatal.
#   Therefore, CrashSevr will be not be counted on.
bike_crashes <- bike_crashes %>%
  select(-X, -Y, -matches('OBJECT'), -DrvrInjury, -CrashSevr)
# # 271 deaths that were biking or driving, mostly bicyclist (269) deaths
# bike_crashes %>% 
#   filter(str_detect(BikeInjury, 'K:') | str_detect(DrvrInjury, 'K:'))
# # 2 driver deaths in the whole dataset
# bike_crashes %>% 
#   filter(str_detect(DrvrInjury, 'K:'))
# # 278 total deaths, 7 deaths that aren't clear since there is no indication if 
# # bicyclist or driver was killed.
# bike_crashes %>% 
#   filter(str_detect(CrashSevr, 'K:')) 
# # These are the 7 deaths that can't be explained by bicyclist(s) and 
# # driver(s). There seems to be a third party involved that is not listed in 
# # records, i.e. other pedestrian or other cyclist that didn't cause the crash 
# # but was affected by the crash.  It may be good to remove these records since 
# # they are misleading without more information on how the deaths occurred.
# bike_crashes %>% 
#   filter(
#     str_detect(CrashSevr, 'K:') & 
#     !str_detect(BikeInjury, 'K:') & 
#     !str_detect(DrvrInjury, 'K:')
#    ) 

## Duplicates: ##
# Note duplicate crash report for CrashID == 1041566349; note that only 
# CrashLoc and CrashType are different. Based on the first record, the driver is
# taking a right turn, but listed as non-intersection; in second record, 
# CrashType is "motorist overtaking - Other/Unknown" and Crash Location is 
# listed as intersection. Therefore, the CrashLoc was likely an intersection 
# where a motorist overtook a bicyclist.  This crash record will need to be 
# fixed to reflect this and remove duplication.
bike_crashes[duplicated(bike_crashes$CrashID), 'CrashID'] %>% 
  kable(caption = 'Duplicate Record CrashID')
bike_crashes %>%
  filter(CrashID == 104156349) %>%
  glimpse()

# Fix duplicate record
bike_crashes <- 
  bike_crashes %>%
  filter(CrashID != '104156349') %>%
  bind_rows(
    bike_crashes %>% 
      filter(CrashID == '104156349') %>%
      slice(1) %>% # grab first record and make changes
      mutate(
        CrashLoc = 'Intersection-Related',
        CrashType = 'Motorist Right Turn - Same Direction',
        CrashGrp = 'Motorist Right Turn / Merge'
      )
  )

glimpse(bike_crashes)
```

### Data Preparation

data cleaning is done in this section using tidyverse methods.

```{r clean_data, echo=TRUE, message=FALSE, warning=FALSE}
bike_crashes_clean <- 
  bike_crashes %>%
  mutate(
    AmbulanceR = fct_relevel(AmbulanceR, 'No', 'Yes'),
    BikeAge = as.numeric(BikeAge),
    # unlikely anyone over 100 years old
    BikeAge = if_else(BikeAge > 100 | BikeAge == 'Unknown', NA_real_, BikeAge),
    BikeAgeGrp = case_when(
      BikeAgeGrp == '06-Oct' ~ '6-10',
      BikeAgeGrp == 'Nov-15' ~ '11-15',
      BikeAgeGrp == 'Unknown' ~ NA_character_,
      TRUE ~ BikeAgeGrp
    ),
    BikeAlcDrg = case_when(
      BikeAlcDrg == '.' ~ NA_character_,
      BikeAlcDrg == 'Missing' ~ NA_character_,
      BikeAlcDrg == 'Unknown' ~ NA_character_,
      TRUE ~ BikeAlcDrg
    ),
    BikeAlcFlg = case_when(
      BikeAlcFlg == 'Missing' ~ NA_character_,
      BikeAlcFlg == 'Unknown' ~ NA_character_,
      TRUE ~ BikeAlcFlg
    ),
    BikeAlcFlg = fct_relevel(BikeAlcFlg, 'No', 'Yes'),
    BikeDir = if_else(BikeDir == 'Unknown', NA_character_, BikeDir),
    BikePos = if_else(BikePos == 'Unknown', NA_character_, BikePos),
    BikeRace = if_else(BikeRace == 'Unknown/Missing', NA_character_, BikeRace),
    BikeSex = if_else(BikeSex == 'Unknown', NA_character_, BikeSex),
    BikeSex = fct_relevel(BikeSex, 'Male', 'Female'),
    CrashAlcoh = fct_relevel(CrashAlcoh, 'No', 'Yes'),
    CrashGrp = if_else(
      CrashGrp == 'Other / Unknown - Insufficient Details', 
      NA_character_, 
      CrashGrp
    ),
    CrashLoc = if_else(CrashLoc == 'Unknown Location', NA_character_, CrashLoc),
    CrashDay = factor(CrashDay,
      levels = c('Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 
                 'Friday', 'Saturday')
    ),
    CrashMonth = factor(CrashMonth,
      levels = c('January', 'February', 'March' ,'April', 'May', 
                 'June', 'July', 'August', 'September', 'October', 
                 'November', 'December')
    ),
    CrashType = if_else(
      CrashType %in% c('Unknown Approach Paths', 'Unknown Location'), 
      NA_character_, 
      CrashType
    ),
    CrashType = str_replace_all(CrashType, '\\s|-|/', '.'),
    CrashType = str_replace_all(CrashType, '\\.{2,}', '.'),
    DrvrAge = as.numeric(DrvrAge),
    # unlikely anyone over 100 years old
    DrvrAge = if_else(
      DrvrAge > 100 | DrvrAge == '70+' | DrvrAge == 'Unknown', 
      NA_real_, 
      DrvrAge
    ),
    DrvrAgeGrp = if_else(
      DrvrAgeGrp == 'Unknown', 
      NA_character_, 
      DrvrAgeGrp
    ),
    DrvrAlcDrg = case_when(
      DrvrAlcDrg == '.' ~ NA_character_,
      DrvrAlcDrg == 'Missing' ~ NA_character_,
      DrvrAlcDrg == 'Unknown' ~ NA_character_,
      TRUE ~ DrvrAlcDrg
    ),
    DrvrAlcFlg = case_when(
      DrvrAlcFlg == 'Missing' ~ NA_character_,
      DrvrAlcFlg == 'Unknown' ~ NA_character_,
      TRUE ~ DrvrAlcFlg
    ),
    DrvrAlcFlg = fct_relevel(DrvrAlcFlg, 'No', 'Yes'),
    DrvrRace = if_else(
      DrvrRace == 'Unknown/Missing', 
      NA_character_, 
      DrvrRace
    ),
    DrvrSex = if_else(DrvrSex == 'Unknown', NA_character_, DrvrSex),
    DrvrSex = fct_relevel(DrvrSex, 'Male', 'Female'),
    HitRun = fct_relevel(HitRun, 'No', 'Yes'),
    LightCond = if_else(LightCond == 'Unknown', NA_character_, LightCond),
    NumBicsAin = if_else(NumBicsAin == '.', NA_character_, NumBicsAin),
    NumBicsBin = if_else(NumBicsBin == '.', NA_character_, NumBicsBin),
    NumBicsCin = if_else(NumBicsCin == '.', NA_character_, NumBicsCin),
    NumBicsKil = if_else(NumBicsKil == '.', NA_character_, NumBicsKil),
    NumBicsNoi = if_else(NumBicsNoi == '.', NA_character_, NumBicsNoi),
    NumBicsUin = if_else(NumBicsUin == '.', NA_character_, NumBicsUin),
    NumBicsTot = if_else(NumBicsTot == '.', NA_character_, NumBicsTot),
    NumLanes = if_else(NumLanes == 'Unknown', NA_character_, NumLanes),
    NumLanes = if_else(NumLanes == '9 or more lanes', '9+ lanes', NumLanes),
    NumLanes = factor(NumLanes, 
      levels = c('1 lane', '2 lanes', '3 lanes', '4 lanes', '5 lanes', 
                 '6 lanes', '7 lanes', '8 lanes', '9+ lanes')
    ),
    RdCharacte = if_else(RdCharacte == 'Unknown', NA_character_, RdCharacte),
    RdClass = if_else(RdClass %in% c('.', 'missing', 'Unknown'), NA_character_, RdClass),
    RdConditio = if_else(RdConditio == 'Unknown', NA_character_, RdConditio),
    RdConfig = if_else(RdConfig == 'Unknown', NA_character_, RdConfig),
    RdDefects = if_else(RdDefects %in% c('Unknown', 'Missing'), NA_character_, RdDefects),
    RdFeature = if_else(RdFeature == 'Missing', NA_character_, RdFeature),
    RdSurface = if_else(RdSurface %in% c('Unknown', 'Missing'), NA_character_, RdSurface),
    RuralUrban = if_else(RuralUrban == '.', NA_character_, RuralUrban),
    SpeedLimit = if_else(SpeedLimit == 'Unknown', NA_character_, SpeedLimit),
    # extra spaces between meaure and units have been removed
    SpeedLimit = str_replace(SpeedLimit, '\\s{2}', ' '), 
    SpeedLimit = factor(SpeedLimit,
      levels = c('5 - 15 MPH', '20 - 25 MPH', '30 - 35 MPH', '40 - 45 MPH', 
                 '50 - 55 MPH', '60 - 75 MPH')
    ),
    TraffCntrl = if_else(TraffCntrl == 'Missing', NA_character_, TraffCntrl),
    Workzone = fct_relevel(Workzone, 'No', 'Yes')
  ) %>%
  # transform char columns that need to be split
  separate(
    col = BikeInjury,
    into = c('BikeInjuryCat', 'BikeInjuryDisc'),
    sep = ': '
  ) %>%
  mutate(
    BikeInjuryCat = if_else(BikeInjuryCat == 'Unknown Injury', 'U', BikeInjuryCat),
    BikeInjuryDisc = if_else(is.na(BikeInjuryDisc), 'Unknown Injury', BikeInjuryDisc),
    # create dichotomous response variable in case multinomial isn't fruitful
    BikeInjurySerious = case_when(
      BikeInjuryCat %in% c('A' ,'K') ~ 1, 
      BikeInjuryCat %in% c('B', 'C', 'O') ~ 0,
      BikeInjuryCat %in% c('U') ~ NA_real_
    )
  ) %>%
  filter(
    !is.na(BikeInjurySerious)
  ) %>%
  # group specific calculations and imputations
  group_by(BikeAgeGrp) %>%
  mutate(
    # median imputation for age group 70+
    BikeAge = if_else(is.na(BikeAge), median(BikeAge, na.rm = T), BikeAge)
  ) %>%
  ungroup() %>%
  # if no age group given for biker, just use median value of full dataset
  mutate(
    BikeAge = if_else(is.na(BikeAge), median(BikeAge, na.rm = T), BikeAge)
  ) %>%
  group_by(DrvrAgeGrp) %>%
  mutate(
    # median imputation for age (years) recorded as 70+
    DrvrAge = if_else(is.na(DrvrAge), median(DrvrAge, na.rm = T), DrvrAge)
  ) %>%
  ungroup() %>%
  # if no age group given for driver, just use median value of full dataset
  mutate(
    DrvrAge = if_else(is.na(DrvrAge), median(DrvrAge, na.rm = T), DrvrAge)
  ) %>%
  # convert all character vectors to factors
  mutate(across(where(is.character), ~ factor(.x))) %>%
  # find and remove any factor variables with less than 2 factors
  select(-where(~is.factor(.x) & length(levels(.x)) < 2)) %>% 
  # fill in NA's with No's if a Yes/No variable to preserve data
  mutate(across(where(
    ~is.factor(.x) & 'No' %in% levels(.x)), 
    ~replace_na(.x, 'No')
  ))

# percent of missing data in each column
bike_crashes_clean %>%
  map(~ round(sum(is.na(.x)) / nrow(bike_crashes_clean) * 100, 1)) %>%
  as_tibble()

# glimpse(bike_crashes_clean)
```

### Create Dummy Variables

convert categorical variables to dummy variables.  Some name fixes will be 
required to make column names more consistent.  If any binary features have NA's
then replace with 0's to preserve largest complete dataset possible.

```{r create_dummies}
bike_crash_dummies_mdl <- dummyVars(
  # keep BikeInjurySerious in the matrix since already numeric
  ~ ., 
  data = bike_crashes_clean,
  sep = '.',
  fullRank = TRUE
)

bike_crash_dummies <- predict(
  bike_crash_dummies_mdl, 
  newdata = bike_crashes_clean
)

# clean up variable names
bike_crash_dummies <- bike_crash_dummies %>% 
  as_tibble() %>%
  rename_with(
    function(x) {
      tmp <- str_replace_all(x, '\\s|/|-', '.')
      tmp <- str_replace_all(tmp, '\\(|\\)|\\+|\\,', '')
      tmp <- str_replace_all(tmp, '>', 'GT')
      tmp <- str_replace_all(tmp, '<', 'LT')
      tmp <- str_replace_all(tmp, '%', 'pct')
      tmp <- str_replace_all(tmp, '\\.{2,}', '.')
    }
  )

# fill in NA's for binary variables with zero since there was no detection
bike_crash_dummies <- bike_crash_dummies %>% 
  mutate(across(
    where(~n_distinct(.x) == 3 & any(is.na(unique(.x)))), 
    ~replace_na(.x, 0)
  ))

# bike_crash_dummies %>% glimpse()
```

### Correlated Variables

In this section, correlated features will be removed based on complete cases.
Any variables with zero variance after filtering for complete cases will be
removed because they won't offer any information to a model.

```{r corr_vars}
# if we look at correlation we'll have to use complete cases
# let's see what variables have the most missing data
# since approximately 13-14% are missing. With certain models complete.obs 
# should be sufficient.

# after filtering for complete cases, how many vars would have zero variance?
zero_variance_vars <- bike_crash_dummies %>%
  filter(complete.cases(.)) %>%
  nearZeroVar(., saveMetrics=TRUE) %>%
  filter(zeroVar) %>% 
  rownames()

# remove variables that are zero-variance after removing rows w/ missing data
bike_crash_dummies <- 
  bike_crash_dummies %>%
  select(-zero_variance_vars)

# Check for any correlated predictors
# compute correlation
bike_crash_dummies_cor <- cor(
  bike_crash_dummies %>%
    select(-BikeInjurySerious), # don't check the response variable
  use = 'complete.obs'
)

# find variables with high pair-wise correlation to potentially remove
correlated_vars <- findCorrelation(
  bike_crash_dummies_cor, 
  cutoff = .75, # default (.90)
  names = TRUE
)

# remove highly correlated variables of interest and zero var. variables
bike_crash_dummies <- bike_crash_dummies %>%
  select(
    -correlated_vars,
    -matches('AmbulanceR'), # if ambulance used, too late, injury is severe, remove variable
    -matches('Disc'), # directly related to BikeInjurySerious (response)
    -matches('Cat'), # directly related to BikeInjurySerious (response)
    -(NumBicsAin.1:NumBicsNoi.2) # directly related to BikeInjury categories
  )

# bike_crash_dummies %>%
#   glimpse()
```

### Save Datasets

```{r save_derived_data}
saveRDS(bike_crashes_clean, './derived_data/bike_crashes_clean.rds')
saveRDS(bike_crash_dummies, './derived_data/bike_crash_dummies.rds')
```
